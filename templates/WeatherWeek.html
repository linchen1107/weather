{% extends "base.html" %}
{% block content %}
<div class="container-lg py-3">
  <h1 class="text-center mb-4">é«˜é›„å¸‚å¤©æ°£</h1>
  
  <!-- å–å¾—ä½¿ç”¨è€…ä½ç½®å€å¡Š -->
  <div class="mb-4 text-center">
    <button id="geolocation" class="btn btn-primary">å–å¾—æˆ‘çš„ä½ç½®</button>
    <p id="userLocation" class="mt-2"></p>
  </div>
  
  <!-- é è¨­å³æ™‚è§€æ¸¬è³‡æ–™ (é è¨­å¤§ç¤¾å€) -->
  <div id="defaultRealtime">
    <h2 class="mb-4">å³æ™‚è§€æ¸¬è³‡æ–™ (é è¨­å¤§ç¤¾å€)</h2>
    {% if weather_data %}
      {% for data in weather_data %}
        {% set weather_icon = 'bi-cloud-sun' %}
        {% if 'æ™´' in data.weather_status %}
          {% set weather_icon = 'bi-sun' %}
        {% elif 'é›¨' in data.weather_status %}
          {% set weather_icon = 'bi-cloud-rain' %}
        {% elif 'é™°' in data.weather_status %}
          {% set weather_icon = 'bi-cloudy' %}
        {% endif %}
        <div class="card mb-3" style="box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-family: 'DFKai-SB', 'æ¨™æ¥·é«”', serif;">
          <div class="row g-0">
            <div class="col-md-4 d-flex flex-column justify-content-center align-items-center p-4"
                 style="background: linear-gradient(135deg, #c2a98d 0%, #e6ceac 100%); color: #5c4033;">
              <i class="bi {{ weather_icon }} fs-2 mb-2"></i>
              <p class="temp-number mb-1" style="font-size: 2rem; font-weight: 700;">{{ data.temperature }} Â°C</p>
              <small class="temp-label">æ°£æº«</small>
            </div>
            <div class="col-md-8">
              <div class="card-body">
                <h4 class="card-title mb-2">{{ data.station }}</h4>
                <p><strong>è§€æ¸¬æ™‚é–“ï¼š</strong>{{ data.time }}</p>
                <p><strong>å¤©æ°£ç‹€æ³ï¼š</strong>{{ data.weather_status }}</p>
                <p><strong>é™é›¨æ©Ÿç‡ï¼š</strong> {{ data.rain_prob }}%</p>
                <div class="progress mb-2" style="height: 20px;">
                  <div class="progress-bar bg-warning" role="progressbar" 
                       style="width: {{ data.rain_prob }}%;" 
                       aria-valuenow="{{ data.rain_prob }}" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                <p><strong>é«”æ„Ÿæº«åº¦ï¼š</strong>{{ data.apparent_temperature }} Â°C</p>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-center">ç›®å‰æ²’æœ‰å³æ™‚è§€æ¸¬è³‡æ–™ã€‚</p>
    {% endif %}
  </div>
  
  <!-- ä½¿ç”¨è€…ä½ç½®é¡¯ç¤ºã€ç”± geolocation å–å¾—è³‡æ–™å¾Œè¦†è“‹ -->
  <div id="realtimeWeather"></div>
  
  <!-- ä¸€å‘¨å¤©æ°£é å ± -->
  <h2 class="mt-5 mb-3">ä¸€å‘¨å¤©æ°£é å ±</h2>
  <div class="mb-4">
    <label for="districtSelector" class="form-label">é¸æ“‡åœ°å€</label>
    <select id="districtSelector" class="form-select">
      <option value="" selected>è«‹é¸æ“‡å€åŸŸ</option>
      {% for d in districts %}
        <option value="{{ d }}">{{ d }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="row row-cols-1 row-cols-md-3 g-4" id="forecastCards" style="display: none;">
    {% if forecast %}
      {% for day in forecast %}
        <div class="col forecast-card-wrapper" data-district="{{ day.district.strip() }}">
          <div class="card h-100" style="box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-family: 'DFKai-SB', 'æ¨™æ¥·é«”', serif;">
            <div class="text-center fs-5 p-2" 
                 style="background-color: #c2a98d; color: #5c4033;">
              {{ day.date }}<br>
              <small>{{ day.district }}</small>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-center mb-3" style="gap: 0.5rem;">
                {% set weather_icon = 'bi-cloud-sun' %}
                {% if 'æ™´' in day.weather %}
                  {% set weather_icon = 'bi-sun' %}
                {% elif 'é›¨' in day.weather %}
                  {% set weather_icon = 'bi-cloud-rain' %}
                {% elif 'é™°' in day.weather %}
                  {% set weather_icon = 'bi-cloudy' %}
                {% endif %}
                <i class="bi {{ weather_icon }} fs-2"></i>
                <span>{{ day.weather }}</span>
              </div>
              <p class="mb-1"><strong>æœ€é«˜æº«ï¼š</strong>{{ day.max_temp }} Â°C</p>
              <p class="mb-1"><strong>æœ€ä½æº«ï¼š</strong>{{ day.min_temp }} Â°C</p>
              <p class="mb-1"><strong>é™é›¨æ©Ÿç‡ï¼š</strong></p>
              <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar bg-warning" role="progressbar" 
                     style="width: {{ day.rain_prob }}%;" 
                     aria-valuenow="{{ day.rain_prob }}" aria-valuemin="0" aria-valuemax="100">
                  {{ day.rain_prob }}%
                </div>
              </div>
              <p class="mb-0"><strong>é«”æ„Ÿï¼š</strong>
                <span style="font-weight:700;"
                      class="{% if day.comfort == 'å¯’å†·' %}text-primary{% elif day.comfort == 'ç•¥æœ‰å¯’æ„' %}text-info{% else %}text-success{% endif %}">
                  {{ day.comfort }}
                </span>
              </p>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  
  <!-- ä¸€å‘¨å¤©æ°£é å ±æŠ˜ç·šåœ– -->
  <div id="chartContainer" style="display: none;">
    <h2 class="mt-5 mb-3">ä¸€å‘¨å¤©æ°£é å ±æŠ˜ç·šåœ–</h2>
    <canvas id="weatherChart"></canvas>
  </div>
</div>

<!-- å°‡å¾Œç«¯å‚³å…¥çš„ forecast è³‡æ–™å­˜å…¥å‰ç«¯è®Šæ•¸ -->
<script>
  var forecastData = {{ forecast|tojson }};
</script>

<!-- è®€å–ä½¿ç”¨è€…ä½ç½®ä¸¦æ›´æ–°å³æ™‚è§€æ¸¬è³‡æ–™ -->
<script>
  function reverseGeocode(lat, lon) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
      .then(response => response.json())
      .then(data => {
        let district = "";
        if (data.address) {
          if (data.address.city_district) {
            district = data.address.city_district;
          } else if (data.address.suburb) {
            district = data.address.suburb;
          } else {
            let match = data.display_name.match(/([^,]+å€)/);
            if (match) {
              district = match[1];
            }
          }
        }
        const userLocation = document.getElementById('userLocation');
        userLocation.textContent = `æ‚¨ä½æ–¼: ${data.display_name} (ç·¯åº¦: ${lat}, ç¶“åº¦: ${lon})`;
        
        if (district) {
          fetch(`/realtime?district=${encodeURIComponent(district)}&lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(weatherData => {
              let html = `<h4 class="mt-3" style="font-family: 'DFKai-SB', 'æ¨™æ¥·é«”', serif;">å³æ™‚è§€æ¸¬è³‡æ–™ - ${district}</h4>`;
              if (weatherData.length > 0) {
                weatherData.forEach(item => {
                  html += `
                    <div class="card mb-3" style="box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-family: 'DFKai-SB', 'æ¨™æ¥·é«”', serif;">
                      <div class="row g-0">
                        <div class="col-md-4 d-flex flex-column justify-content-center align-items-center p-4"
                             style="background: linear-gradient(135deg, #c2a98d 0%, #e6ceac 100%); color: #5c4033;">
                          <i class="bi bi-cloud-sun fs-2 mb-2"></i>
                          <p class="temp-number mb-1" style="font-size: 2rem; font-weight: 700;">${item.temperature} Â°C</p>
                          <small class="temp-label">æ°£æº«</small>
                        </div>
                        <div class="col-md-8">
                          <div class="card-body">
                            <h4 class="card-title mb-2">${item.station}</h4>
                            <p><strong>è§€æ¸¬æ™‚é–“ï¼š</strong>${item.time}</p>
                            <p><strong>å¤©æ°£ç‹€æ³ï¼š</strong>${item.weather_status}</p>
                            <p><strong>é™é›¨æ©Ÿç‡ï¼š</strong>${item.rain_prob}%</p>
                            <div class="progress mb-2" style="height: 20px;">
                              <div class="progress-bar bg-warning" role="progressbar"
                                   style="width: ${item.rain_prob}%;"
                                   aria-valuenow="${item.rain_prob}" aria-valuemin="0" aria-valuemax="100">
                              </div>
                            </div>
                            <p><strong>é«”æ„Ÿæº«åº¦ï¼š</strong>${item.apparent_temperature} Â°C</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                });
              } else {
                html = `<h4 class="mt-3" style="font-family: 'DFKai-SB', 'æ¨™æ¥·é«”', serif;">å³æ™‚è§€æ¸¬è³‡æ–™ - ${district}</h4>
                        <p>ç›®å‰æŸ¥ç„¡ ${district} çš„å³æ™‚è§€æ¸¬è³‡æ–™ã€‚</p>`;
              }
              document.getElementById('defaultRealtime').style.display = 'none';
              document.getElementById('realtimeWeather').innerHTML = html;
            });
        } else {
          document.getElementById('realtimeWeather').innerHTML = `<p>ç„¡æ³•è§£ææ‚¨çš„å€åŸŸè³‡è¨Šã€‚</p>`;
        }
      })
      .catch(error => {
        const userLocation = document.getElementById('userLocation');
        userLocation.textContent = `å–å¾—ä½ç½®è³‡è¨Šå¤±æ•—: ${error}`;
      });
  }

  const geolocationBtn = document.getElementById('geolocation');
  const locationSwitch = document.getElementById('locationSwitch');
  const locationLabel = document.getElementById('locationLabel');
  geolocationBtn.addEventListener('click', function () {
    // é»æ“Šã€Œå–å¾—æˆ‘çš„ä½ç½®ã€æ™‚è‡ªå‹•é–‹å•Ÿä½ç½®æœå‹™
    locationSwitch.checked = true;
    locationLabel.textContent = 'ä½ç½®æœå‹™: ON';

    if ("geolocation" in navigator) {
      function successCallback(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        reverseGeocode(latitude, longitude);
      }
      function errorCallback(error) {
        document.getElementById('userLocation').textContent = `éŒ¯èª¤ï¼š${error.message}`;
      }
      const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
      navigator.geolocation.getCurrentPosition(successCallback, errorCallback, options);
    } else {
      document.getElementById('userLocation').textContent = "ç€è¦½å™¨ä¸æ”¯æ´ Geolocation";
    }
  });
</script>

<!-- è¼‰å…¥ Chart.js ä¸¦è¨­å®šä¸€å‘¨æŠ˜ç·šåœ– -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* 
  STEP 1: å°‡åŸå§‹å¤©æ°£æè¿°ç°¡åŒ–ç‚ºã€Œæ™´å¤© / é™°å¤© / å¯èƒ½ä¸‹é›¨ / é™°å¤©ã€å¯èƒ½ä¸‹é›¨ / æœªçŸ¥ã€
  - è‹¥æè¿°åŒæ™‚åŒ…å«ã€Œé™° / é›²ã€èˆ‡ã€Œé›¨ã€ï¼Œå‰‡é¡¯ç¤ºã€Œé™°å¤©ã€å¯èƒ½ä¸‹é›¨ã€
  - è‹¥åŒ…å«ã€Œæ™´ã€å°±ç›´æ¥é¡¯ç¤ºã€Œæ™´å¤©ã€
  - å…¶é¤˜ä¾é—œéµå­—ç•¥ä½œå€åˆ†
*/
function simplifyWeatherDesc(desc) {
  desc = desc || "";
  // 1) è‹¥å«ã€Œæ™´ã€ => ç›´æ¥åˆ¤å®šç‚ºã€Œæ™´å¤©ã€
  if (desc.includes("æ™´")) {
    return "æ™´å¤©";
  }
  // 2) è‹¥å«ã€Œé›¨ã€ => å†åˆ¤æ–·æ˜¯å¦ä¹Ÿå«ã€Œé™°ã€æˆ–ã€Œé›²ã€
  if (desc.includes("é›¨")) {
    if (desc.includes("é™°") || desc.includes("é›²")) {
      return "é™°å¤©ã€å¯èƒ½ä¸‹é›¨";
    }
    return "å¯èƒ½ä¸‹é›¨";
  }
  // 3) è‹¥å«ã€Œé™°ã€æˆ–ã€Œé›²ã€ => ã€Œé™°å¤©ã€
  if (desc.includes("é™°") || desc.includes("é›²")) {
    return "é™°å¤©";
  }
  // 4) å¦å‰‡ => ã€ŒæœªçŸ¥ã€
  return "æœªçŸ¥";
}

/* 
  STEP 2: æ ¹æ“šç°¡åŒ–å¾Œçš„æè¿°ï¼Œè¿”å›å°æ‡‰çš„ Emoji
*/
function getWeatherEmoji(simplifiedDesc) {
  switch (simplifiedDesc) {
    case "æ™´å¤©":
      return 'â˜€';
    case "é™°å¤©":
      return 'â˜';
    case "å¯èƒ½ä¸‹é›¨":
    case "é™°å¤©ã€å¯èƒ½ä¸‹é›¨":
      return 'ğŸŒ§';
    default:
      return 'ğŸŒ¤'; // é è¨­
  }
}

const districtSelector = document.getElementById("districtSelector");
const forecastCardsContainer = document.getElementById("forecastCards");
const chartContainer = document.getElementById("chartContainer");

districtSelector.addEventListener("change", function(){
  var selected = this.value.trim();
  var cards = document.getElementsByClassName("forecast-card-wrapper");
  var anyVisible = false;
  if(selected === ""){
    for (var i = 0; i < cards.length; i++) {
      cards[i].style.display = "none";
    }
    chartContainer.style.display = "none";
  } else {
    for (var i = 0; i < cards.length; i++) {
      var cardDistrict = cards[i].getAttribute("data-district").trim();
      if(cardDistrict === selected) {
        cards[i].style.display = "block";
        anyVisible = true;
      } else {
        cards[i].style.display = "none";
      }
    }
    forecastCardsContainer.style.display = anyVisible ? "flex" : "none";
    chartContainer.style.display = anyVisible ? "block" : "none";
    updateChart(selected);
  }
});

// åˆå§‹åŒ– Chart.js æŠ˜ç·šåœ– (æœ€é«˜æº«èˆ‡æœ€ä½æº«)
var ctx = document.getElementById('weatherChart').getContext('2d');
var weatherChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'æœ€é«˜æº«',
      data: [],
      borderColor: 'rgba(205, 92, 92, 1)',     // å°ç¬¬å®‰ç´…
      backgroundColor: 'rgba(205, 92, 92, 0.2)',
      fill: false,
      tension: 0.1
    },
    {
      label: 'æœ€ä½æº«',
      data: [],
      borderColor: 'rgba(72, 61, 139, 1)',     // æ·±ç´«è—
      backgroundColor: 'rgba(72, 61, 139, 0.2)',
      fill: false,
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    // æ»‘é¼ åœ¨åœ–è¡¨ä¸Šç§»å‹•æ™‚ï¼Œè‡ªå‹•æ‰¾æœ€è¿‘çš„é»é¡¯ç¤º tooltip
    interaction: {
      mode: 'nearest',
      intersect: false
    },
    plugins: {
      tooltip: {
        // èª¿æ•´ Tooltip å¤–è§€ï¼šèƒŒæ™¯ã€å­—å‹å¤§å°ã€é–“è·ç­‰
        backgroundColor: 'rgba(0, 0, 0, 0.8)',
        cornerRadius: 10,
        padding: 12,
        titleColor: '#fff',
        bodyColor: '#fff',
        titleFont: { size: 18 },
        bodyFont: { size: 16 },
        displayColors: false,
        callbacks: {
          label: function(context) {
            let index = context.dataIndex;
            // å–å‡ºè©²é»å°æ‡‰çš„é å ±è³‡æ–™
            let data = window.currentForecastData && window.currentForecastData[index];
            let label = context.dataset.label || '';
            let value = context.parsed.y;
            if (!data) {
              return `${label}: ${value}Â°C`;
            }
            // é€²è¡Œå¤©æ°£æè¿°ç°¡åŒ–
            let simpleDesc = simplifyWeatherDesc(data.weather);
            let weatherIcon = getWeatherEmoji(simpleDesc);
            // é¡¯ç¤ºã€Œæœ€é«˜(æˆ–æœ€ä½)æº«åº¦ + ç°¡åŒ–å¤©æ°£ + é™é›¨æ©Ÿç‡ + é«”æ„Ÿã€
            return `${label}: ${value}Â°C | ${weatherIcon} ${simpleDesc}, é™é›¨: ${data.rain_prob}%, é«”æ„Ÿ: ${data.comfort}`;
          }
        }
      }
    },
    scales: {
      x: { 
        title: { display: true, text: 'æ—¥æœŸ' }
      },
      y: { 
        title: { display: true, text: 'æº«åº¦ (Â°C)' }
      }
    }
  }
});

/* 
  STEP 3: æ›´æ–°åœ–è¡¨è³‡æ–™
  - å¾ forecastData éæ¿¾å‡ºä½¿ç”¨è€…é¸æ“‡çš„å€åŸŸï¼Œå­˜å…¥å…¨åŸŸè®Šæ•¸ currentForecastData
  - æ›´æ–°æŠ˜ç·šåœ–
*/
function updateChart(selectedDistrict) {
  var filtered = forecastData.filter(function(entry){
    return entry.district.trim() === selectedDistrict;
  });
  // å­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œtooltip å¯ç›´æ¥æ‹¿ä¾†ç”¨
  window.currentForecastData = filtered;

  var labels = filtered.map(function(entry){ return entry.date; });
  var maxTemps = filtered.map(function(entry){ return entry.max_temp; });
  var minTemps = filtered.map(function(entry){ return entry.min_temp; });
  
  weatherChart.data.labels = labels;
  weatherChart.data.datasets[0].data = maxTemps;
  weatherChart.data.datasets[1].data = minTemps;
  weatherChart.update();
}
</script>


{% endblock %}
